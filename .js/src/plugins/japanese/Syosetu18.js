var e=this&&this.__assign||function(){return e=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},e.apply(this,arguments)},t=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(a,i){function o(e){try{s(n.next(e))}catch(e){i(e)}}function l(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,l)}s((n=n.apply(e,t||[])).next())}))},r=this&&this.__generator||function(e,t){var r,n,a,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=l(0),o.throw=l(1),o.return=l(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function l(l){return function(s){return function(l){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,l[0]&&(i=0)),i;)try{if(r=1,n&&(a=2&l[0]?n.return:l[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,l[1])).done)return a;switch(n=0,a&&(l=[2&l[0],a.value]),l[0]){case 0:case 1:a=l;break;case 4:return i.label++,{value:l[1],done:!1};case 5:i.label++,n=l[1],l=[0];continue;case 7:l=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==l[0]&&2!==l[0])){i=0;continue}if(3===l[0]&&(!a||l[1]>a[0]&&l[1]<a[3])){i.label=l[1];break}if(6===l[0]&&i.label<a[1]){i.label=a[1],a=l;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(l);break}a[2]&&i.ops.pop(),i.trys.pop();continue}l=t.call(e,i)}catch(e){l=[6,e],n=0}finally{r=a=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,s])}}};Object.defineProperty(exports,"__esModule",{value:!0});var n=require("cheerio"),a=require("@libs/fetch"),i=require("@libs/defaultCover"),o=require("@libs/filterInputs"),l=require("@libs/novelStatus"),s=function(){function s(){var e=this;this.id="noc.syosetu",this.name="Syosetu18 (Nocturne)",this.icon="src/jp/syosetu18/icon.png",this.site="https://noc.syosetu.com",this.novelDomain="https://novel18.syosetu.com",this.version="1.2.3",this.headers={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"},this.searchUrl=function(t,r){return"".concat(e.site,"/search/search/search.php?order=").concat(r||"hyoka").concat(void 0!==t?"&p=".concat(t<=1||t>100?"1":t):"")},this.filters={ranking:{type:o.FilterTypes.Picker,label:"Ranked by",options:[{label:"日間",value:"daily"},{label:"週間",value:"weekly"},{label:"月間",value:"monthly"},{label:"四半期",value:"quarter"},{label:"年間",value:"yearly"},{label:"累計",value:"total"}],value:"total"},genre:{type:o.FilterTypes.Picker,label:"Ranking Genre",options:[{label:"総ジャンル",value:""},{label:"異世界転生/転移〔恋愛〕〕",value:"1"},{label:"異世界転生/転移〔ファンタジー〕",value:"2"},{label:"異世界転生/転移〔文芸・SF・その他〕",value:"o"},{label:"異世界〔恋愛〕",value:"101"},{label:"現実世界〔恋愛〕",value:"102"},{label:"ハイファンタジー〔ファンタジー〕",value:"201"},{label:"ローファンタジー〔ファンタジー〕",value:"202"},{label:"純文学〔文芸〕",value:"301"},{label:"ヒューマンドラマ〔文芸〕",value:"302"},{label:"歴史〔文芸〕",value:"303"},{label:"推理〔文芸〕",value:"304"},{label:"ホラー〔文芸〕",value:"305"},{label:"アクション〔文芸〕",value:"306"},{label:"コメディー〔文芸〕",value:"307"},{label:"VRゲーム〔SF〕",value:"401"},{label:"宇宙〔SF〕",value:"402"},{label:"空想科学〔SF〕",value:"403"},{label:"パニック〔SF〕",value:"404"},{label:"童話〔その他〕",value:"9901"},{label:"詩〔その他〕",value:"9902"},{label:"エッセイ〔その他〕",value:"9903"},{label:"その他〔その他〕",value:"9999"}],value:""},modifier:{type:o.FilterTypes.Picker,label:"Modifier",options:[{label:"すべて",value:"total"},{label:"連載中",value:"r"},{label:"完結済",value:"er"},{label:"短編",value:"t"}],value:"total"}}}return s.prototype.fetchWithAgeGate=function(n){return t(this,arguments,void 0,(function(t,n){var i;return void 0===n&&(n={}),r(this,(function(r){switch(r.label){case 0:return[4,this.ensureAgeGatePassed(t)];case 1:return r.sent(),i=e(e({},n.headers||{}),this.headers),this.ageCookie&&(i.Cookie=i.Cookie?"".concat(i.Cookie,"; ").concat(this.ageCookie):this.ageCookie),[2,(0,a.fetchApi)(t,e(e({},n),{headers:i}))]}}))}))},s.prototype.ensureAgeGatePassed=function(n){return t(this,void 0,void 0,(function(){var t,i,o,l,s,c,u,h,p,f,v,d,b,y,m,g,k,_,x,w,C,A,S,P,j,F,G;return r(this,(function(r){switch(r.label){case 0:if(this.ageCookie)return[2];r.label=1;case 1:return r.trys.push([1,13,,14]),[4,(0,a.fetchApi)(n,{headers:this.headers})];case 2:return[4,(t=r.sent()).text()];case 3:return i=r.sent(),o=t.url||n,/年齢確認|18歳以上|年齢を確認/.test(i)||/ageauth|age_confirm|agecheck/.test(o)?(l=i.match(/https?:\/\/[^"'<>\s]*ageauth[^"'<>\s]*/i),(s=l?l[0]:null)?[4,(0,a.fetchApi)(s,{headers:this.headers})]:[3,5]):[2];case 4:c=r.sent(),u=c.headers,h=void 0;try{u&&"function"==typeof u.raw&&(p=u.raw())&&p["set-cookie"]&&p["set-cookie"].length&&(h=p["set-cookie"].map((function(e){return e.split(";")[0]})).join("; "))}catch(e){}try{!h&&u&&"function"==typeof u.get&&(f=u.get("set-cookie"))&&(h=Array.isArray(f)?f.map((function(e){return e.split(";")[0]})).join("; "):f.split(";")[0])}catch(e){}if(h)return this.ageCookie=h,[2];r.label=5;case 5:if(!(v=i.match(/<form[^>]*>([\s\S]*?)<\/form>/i)))return[3,9];for(d=v[0],b=d.match(/action=["']([^"']+)["']/i),y=b?b[1]:o,m={},g=/<input[^>]*name=["']([^"']+)["'][^>]*value=["']([^"']*)["'][^>]*>/gi,k=void 0;k=g.exec(d);)m[k[1]]=k[2]||"";r.label=6;case 6:return r.trys.push([6,8,,9]),_=y.startsWith("http")?y:new URL(y,o).href,x=new URLSearchParams(m).toString(),[4,(0,a.fetchApi)(_,{method:"POST",headers:e(e({},this.headers),{"Content-Type":"application/x-www-form-urlencoded",Referer:o}),body:x})];case 7:w=r.sent(),C=w.headers,A=void 0;try{C&&"function"==typeof C.raw&&(S=C.raw())&&S["set-cookie"]&&S["set-cookie"].length&&(A=S["set-cookie"].map((function(e){return e.split(";")[0]})).join("; "))}catch(e){}try{!A&&C&&"function"==typeof C.get&&(P=C.get("set-cookie"))&&(A=Array.isArray(P)?P.map((function(e){return e.split(";")[0]})).join("; "):P.split(";")[0])}catch(e){}return A?(this.ageCookie=A,[2]):[3,9];case 8:return r.sent(),[3,9];case 9:return r.trys.push([9,11,,12]),[4,(0,a.fetchApi)(this.novelDomain,{headers:this.headers})];case 10:return j=r.sent(),(F=j.headers)&&"function"==typeof F.get&&(G=F.get("set-cookie"))&&(this.ageCookie=Array.isArray(G)?G.map((function(e){return e.split(";")[0]})).join("; "):G.split(";")[0]),[3,12];case 11:return r.sent(),[3,12];case 12:return[3,14];case 13:return r.sent(),[3,14];case 14:return[2]}}))}))},s.prototype.popularNovels=function(e,a){return t(this,arguments,void 0,(function(e,a){var o,l=this,s=a.filters;return r(this,(function(a){switch(a.label){case 0:return o=function(e){return t(l,void 0,void 0,(function(){var t,a,o,l,c=this;return r(this,(function(r){switch(r.label){case 0:return t=this.site,s.genre.value?t+="/rank/".concat(1===s.genre.value.length?"isekailist":"genrelist","/type/").concat(s.ranking.value,"_").concat(s.genre.value).concat("total"===s.modifier.value?"":"_".concat(s.modifier.value),"/?p=").concat(e):t+="/rank/list/type/".concat(s.ranking.value,"_").concat(s.modifier.value,"/?p=").concat(e),[4,this.fetchWithAgeGate(t)];case 1:return[4,r.sent().text()];case 2:return a=r.sent(),o=(0,n.load)(a,{decodeEntities:!1}),parseInt(o(".is-current").text()||"1")!==e?[2,[]]:(l=[],o(".c-card, .p-ranklist-item").each((function(e,t){var r=(0,n.load)(t).find(".p-ranklist-item__title a, a").first(),a=r.attr("href");if(a){var o=r.text().trim()||(0,n.load)(t).find(".title").text().trim();l.push({path:a.replace(c.novelDomain,""),name:o,cover:i.defaultCover})}})),[2,l])}}))}))},[4,o(e)];case 1:return[2,a.sent()]}}))}))},s.prototype.parseChaptersFromPage=function(e){return t(this,void 0,void 0,(function(){var t,n=this;return r(this,(function(r){return t=[],e(".p-eplist__sublist, .episode_list, .chapter-list").each((function(r,a){var i=e(a).find("a").first(),o=i.attr("href"),l=i.text().trim(),s=e(a).find(".p-eplist__update").text().trim().split(" ")[0].replace(/\//g,"-")||e(a).find(".date").text().trim().split(" ")[0].replace(/\//g,"-");o&&t.push({name:l,releaseTime:s,path:o.replace(n.novelDomain,"")})})),[2,t]}))}))},s.prototype.parseNovel=function(e){return t(this,void 0,void 0,(function(){var t,a,o,s,c,u,h,p,f,v,d,b,y,m,g,k,_,x,w,C,A,S,P=this;return r(this,(function(r){switch(r.label){case 0:return[4,this.fetchWithAgeGate(this.novelDomain+e)];case 1:return[4,r.sent().text()];case 2:return t=r.sent(),a=(0,n.load)(t,{decodeEntities:!1}),o="Unknown",(s=a(".c-announce").text()).includes("連載中")||s.includes("未完結")?o=l.NovelStatus.Ongoing:s.includes("更新されていません")?o=l.NovelStatus.OnHiatus:s.includes("完結")&&(o=l.NovelStatus.Completed),(c={path:e,name:a(".p-novel__title").text().trim(),author:a(".p-novel__author").text().replace("作者：","").trim(),status:o,artist:"",cover:i.defaultCover,chapters:[],genres:null===(S=a('meta[property="og:description"]').attr("content"))||void 0===S?void 0:S.split(" ").join(",")}).summary=a("#novel_ex").html()||"",u=[],(h=a(".c-pager__item--last").attr("href")||a(".last").attr("href"))?[3,4]:(f=(p=u.push).apply,v=[u],[4,this.parseChaptersFromPage(a)]);case 3:return f.apply(p,v.concat([r.sent()])),[3,9];case 4:return d=h.match(/\?p=(\d+)/),b=d?parseInt(d[1]):1,y=Array.from({length:b},(function(t,r){return P.fetchWithAgeGate("".concat(P.novelDomain).concat(e,"?p=").concat(r+1)).then((function(e){return e.text()}))})),[4,Promise.all(y)];case 5:m=r.sent(),g=0,k=m,r.label=6;case 6:return g<k.length?(_=k[g],x=(0,n.load)(_,{decodeEntities:!1}),C=(w=u.push).apply,A=[u],[4,this.parseChaptersFromPage(x)]):[3,9];case 7:C.apply(w,A.concat([r.sent()])),r.label=8;case 8:return g++,[3,6];case 9:return 0===u.length&&(a(".p-novel__body .p-novel__text").length>0||a("#novel_honbun").length>0)&&u.push({name:"Chapter 1",releaseTime:"",path:e}),c.chapters=u,[2,c]}}))}))},s.prototype.parseChapter=function(e){return t(this,void 0,void 0,(function(){var t,a,i,o,l;return r(this,(function(r){switch(r.label){case 0:return[4,this.fetchWithAgeGate(this.novelDomain+e)];case 1:return[4,r.sent().text()];case 2:if(t=r.sent(),a=(0,n.load)(t,{decodeEntities:!1}),i=a(".p-novel__subtitle").text().trim()||a(".p-novel__title").text().trim()||"Chapter 1",(o=a(".p-novel__text--honbun").html())||(l=[],a(".p-novel__body .p-novel__text").each((function(e,t){l.push(a(t).html()||"")})),o=l.join("<hr/>")),o||(o=a("#novel_honbun").html()||""),!o)throw new Error("Failed to parse chapter content");return[2,"<h1>".concat(i,"</h1>").concat(o)]}}))}))},s.prototype.searchNovels=function(e,a){return t(this,void 0,void 0,(function(){var o,l=this;return r(this,(function(s){switch(s.label){case 0:return o=function(a){return t(l,void 0,void 0,(function(){var t,o,l,s,c=this;return r(this,(function(r){switch(r.label){case 0:return t=this.searchUrl(a)+"&word=".concat(encodeURIComponent(e)),[4,this.fetchWithAgeGate(t)];case 1:return[4,r.sent().text()];case 2:return o=r.sent(),l=(0,n.load)(o,{decodeEntities:!1}),s=[],l(".searchkekka_box, .search-result, .novel_h").each((function(e,t){var r=l(t).find(".novel_h").first()||l(t).find(".title").first(),n=r.children().first(),a=n&&n.attr&&n.attr("href")||r.attr("href");if(a){var o=a.replace(c.novelDomain,"");s.push({name:r.text().trim()||l(t).find("a").first().text().trim(),path:o,cover:i.defaultCover})}})),[2,s]}}))}))},[4,o(a)];case 1:return[2,s.sent()]}}))}))},s.prototype.resolveUrl=function(e){return this.novelDomain+e},s}();exports.default=new s;